<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdn.jsdelivr.net/gh/spiermar/d3-flame-graph@2.0.3/dist/d3-flamegraph.css">
</head>

<body>
  <div class="scale"><span id="start">0</span><span id="end"></span></div>
  <div id="chart"></div>
  <!-- D3.js -->
  <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>

  <!-- d3-tip -->
  <script type="text/javascript" src=https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js> </script>
  <!--
    d3-flamegraph -->
  <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/spiermar/d3-flame-graph@2.0.3/dist/d3-flamegraph.min.js"></script> -->
  <script type="text/javascript"
    src="https://cdn.jsdelivr.net/npm/d3-flame-graph@4.0.6/dist/d3-flamegraph.min.js"></script>
  <script type="text/javascript">

    var stacks = {
      "children": [
        {
          "name": "sss111",
          "value": 12.5,
          "barColor": "#E600E6",
          "end":12.5,
          "children": [
            {
              "name": "s1child",
              "value": 12,
              "barColor": "#E600E6"
            }
          ]
        },
        {
          "name": "s2",
          "value": 12.5,
          "barColor": "#E600E6",
          "end":12.5,
          "children": [
            {
              "name": "s2child",
              "value": 6,
              "barColor": "#E600E6",
              "end":6,
              "children": [
                {
                  "name": "s2subchild1",
                  "value": 2,
                  "barColor": "#E600E6",
                  "end":4,
                  "children": [
                    {
                      "name": "s2subsubchild",
                      "value": 3,
                      "end":3,
                      "barColor": "#E600E6"
                    }]
                },
                {
                  "name": "s2subchild2",
                  "value": 2,
                  "barColor": "#E600E6",
                  "end":2,
                  "children": []
                }
              
              ]
            },
            {
              "name": "s21child",
              "value": 6,
              "barColor": "#E600E6",
              "end":6,
              "children": []
            }
          ]
        }

      ],
      "name": "root",
      "value": 25,
      "end":25,
      "barColor": "#E600E6",
      "nodeId": uuidv4()
    }


    var rootNodeData;
    var rootVal = stacks['value'];
    document.getElementById('end').innerHTML = rootVal;

    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function hideBars(arr, id) {
      arr.forEach(ele => {
        ele.hide = true;
        ele.fade = true;
        ele.barColor = "#E600E6";
        ele.parentId = id;
        ele.nodeId = uuidv4();
        if (ele.children) {
          hideBars(ele.children, ele.nodeId)
        } else {
          ele.children = []
        }
      });
    }

    var hello = JSON.parse(JSON.stringify(stacks));
    hideBars(stacks.children, stacks.nodeId);

    var flameGraph = flamegraph()
      .width(960)
      .cellHeight(18)
      .transitionDuration(750)
      .transitionEase(d3.easeCubic)
      .sort(true)
      .inverted(true)
      .setColorMapper(function (d) {
        return d.data.barColor;
      })
      .onClick((d) => {
        // d.data will get the selected node
        // the below will update the graph 
        // debugger
        let getIds = [];
        getIds.push(d.data.nodeId); //current Node id
        if (d.depth > 0) {
          let nextnodes; let getdata;
          let dData = d;
          //parent
          let parentData = []; let hirarcyData; let childarray; let ids = [];
          for (var i = dData.depth; i > 0; i--) {
            if (getdata) {
              getdata = getdata.parent; '';
              getIds.push(getdata.data.nodeId);
            } else {
              getdata = dData.parent;
              getIds.push(getdata.data.nodeId);
            }
          }
        }
        //get children ids
        let childIds = [];
        if (d.data.children.length > 0) {
          for (let i = 0; i < d.data.children.length; i++) {
            getIds.push(d.data.children[i].nodeId);
            childIds.push(d.data.children[i].nodeId);
          }
        }

        if (!rootNodeData || rootNodeData.length <= 0) {
          rootNodeData = d.data;
        }
        let per = rootVal/d.data.end;
        let rootObjChildren = checkIsHideNode(rootNodeData['children'], getIds,d.data.nodeId,per,childIds);
        let rootObj = {
          barColor: '#bcbcbc',
          name: rootNodeData.name,
          nodeId: rootNodeData.nodeId,
          parentId: rootNodeData.parentId,
          value: rootNodeData.value,
          end: rootNodeData.end,
          fade: false,
          hide: false,
          children: rootObjChildren
        }
        console.log('--rootObjChildren--', rootObj);
        rootNodeData = rootObj
        document.getElementById('footer').style.display = 'block'
        document.getElementById('nodeDataName').innerHTML = d.data.name;
        document.getElementById('nodeDataValue').innerHTML = d.data.end;
        document.getElementById('end').innerHTML = d.data.end;

        var updatedObj = JSON.parse(JSON.stringify(rootObj));
        flameGraph.update(updatedObj);

      })
      //Example to sort in reverse order
      // .sort(function(a,b){ return d3.descending(a.data.name, b.data.name);})
      .title("");

    // Example on how to use custom tooltips using d3-tip.
    var tip = d3.tip()
      .direction("s")
      .offset([8, 0])
      .attr('class', 'd3-flame-graph-tip')
      .html(function (d) { return "name: " + d.data.name + ", value: " + d.data.end; });

    flameGraph.tooltip(tip);

    // Example on how to use custom labels
    // var label = function(d) {
    //  return "name: " + d.data.name + ", value: " + d.data.value;
    // }

    // flameGraph.label(label);

    // d3.json(stacks, function (error, data) {
    // if (error) return console.warn(error);
    var init = d3.select("#chart")
      .datum(stacks)
      .call(flameGraph);


    //set hide nodes
    function checkIsHideNode(data, getIds,id,per,childIds) {
      let childrenNodes = [];
      for (let i = 0; i < data.length; i++) {
        childrenNodes[i] = {}
        for (const [key, value] of Object.entries(data[i])) {
          childrenNodes[i][key] = value;
        }
        childrenNodes[i]['barColor'] = '#3396FF';
        if(id == childrenNodes[i]['nodeId'] && rootVal>childrenNodes[i]['value'] ){
          childrenNodes[i]['value'] = childrenNodes[i]['value']*per;
        }
        if (getIds.indexOf(childrenNodes[i]['nodeId']) != -1) {
          childrenNodes[i]['hide'] = false;
          childrenNodes[i]['fade'] = false;
          if (childIds.indexOf(childrenNodes[i]['nodeId']) != -1){ 
            childrenNodes[i]['value'] = childrenNodes[i]['end']*per;
          }else if(rootVal>childrenNodes[i]['value']){
          childrenNodes[i]['value'] = childrenNodes[i]['value']*per;
          } 
        } else {
          childrenNodes[i]['hide'] = true;
          childrenNodes[i]['fade'] = false;
        }
        if (childrenNodes[i]['children'] && childrenNodes[i]['children'].length > 0) {
          childrenNodes[i]['children'] = checkIsHideNode(childrenNodes[i]['children'], getIds,id,per,childIds);
        }
      }
      return childrenNodes;
    }

  </script>

  <div id="footer">
    <p>Name:- <span id='nodeDataName'></span></p>
    <p>Value:- <span id='nodeDataValue'></span></p>
  </div>
</body>


<style>
  #footer {
    width: 100%;
    top: 99%;
    border: 1px solid;
    display: none;
  }
  .scale{
    width: 960px;
    height: 20px;
    background-color: rgb(43, 219, 72);
    margin: 10px 0;
  }
  body{
     padding-left: 50px;
  }
  #end{
    float: right;
  }
</style>

<!-- required links -->

<!-- How to build data.json from pathes? #89 -->
<!-- https://github.com/spiermar/d3-flame-graph/issues/89 -->

<!-- Chart randomly builds only 3 levels #98 -->
<!-- https://github.com/spiermar/d3-flame-graph/issues/98 -->

<!-- https://github.com/spiermar/d3-flame-graph/commit/2b68c0f54d430c7e1c50686b4b76b416ee9ad8c5 -->